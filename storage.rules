rules_version = '2';

// Firebase Storage rules for Shop360 (Play Store production).
// Only product images and 3D models are stored; no user PII. All writes require verified admin.
service firebase.storage {
  match /b/{bucket}/o {

    // Helper function to check if user is authenticated
    function isSignedIn() {
      return request.auth != null;
    }
    
    // Helper function to check if user is admin
    function isAdmin() {
      return isSignedIn()
        && firestore.exists(/databases/(default)/documents/users/$(request.auth.uid))
        && firestore.get(/databases/(default)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // Helper function to check if email is verified
    function isEmailVerified() {
      return isSignedIn() && request.auth.token.email_verified == true;
    }
    
    // Product Images: images/{productId}/{filename}
    // - Anyone (including unauthenticated users) can read/download product images
    // - Only admins can upload/update/delete product images
    match /images/{productId}/{allPaths=**} {
      allow read: if true; // Public read access for product images
      allow write: if isAdmin() && isEmailVerified(); // Only verified admins can write
    }
    
    // Product 3D Models: models/{productId}/{filename}
    // - Anyone (including unauthenticated users) can read/download product models
    // - Only admins can upload/update/delete product models
    match /models/{productId}/{allPaths=**} {
      allow read: if true; // Public read access for AR models
      allow write: if isAdmin() && isEmailVerified(); // Only verified admins can write
    }
    
    // Deny all other paths by default
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}

