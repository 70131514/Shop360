buildscript {
    ext {
        buildToolsVersion = "34.0.0"
        minSdkVersion = 23
        compileSdkVersion = 34
        targetSdkVersion = 34

        ndkVersion = System.properties['os.arch'] == "aarch64"
                ? "24.0.8215888"
                : "21.4.7075529"

        kotlinVersion = "1.9.22"
        // Use JDK 17 to run Gradle/AGP, but keep most modules targeting Java 11.
        // Some libraries (notably @react-native-firebase/auth v23) require Java 17 language features.
        defaultJavaVersion = JavaVersion.VERSION_11
        defaultKotlinJvmTarget = "11"
        firebaseJavaVersion = JavaVersion.VERSION_17
        firebaseKotlinJvmTarget = "17"
        
        // Google Play Services version - use a compatible version for location services
        // Using version compatible with Firebase and modern Android
        googlePlayServicesVersion = "21.2.0"
        playServicesLocationVersion = "21.2.0"
    }

    repositories {
        google()
        mavenCentral()
    }

    dependencies {
        classpath("com.android.tools.build:gradle:8.1.1")
        classpath("com.facebook.react:react-native-gradle-plugin")
        classpath("org.jetbrains.kotlin:kotlin-gradle-plugin:$kotlinVersion")
        classpath("com.google.gms:google-services:4.4.2")
    }
}

allprojects {
    repositories {
        google()
        mavenCentral()
        maven { url("$rootDir/../node_modules/react-native/android") }
        maven { url("$rootDir/../node_modules/jsc-android/dist") }
        maven { url "https://www.jitpack.io" }
    }
}

/**
 * âœ… FORCE JVM 17 FOR ALL MODULES (THIS FIXES YOUR ERROR)
 */
subprojects {
    // Some dependencies in node_modules declare their own (older) AGP/Kotlin plugin versions.
    // Force them onto our supported versions.
    buildscript {
        configurations.classpath {
            resolutionStrategy.eachDependency { details ->
                if (details.requested.group == "com.android.tools.build" && details.requested.name == "gradle") {
                    details.useVersion("8.1.1")
                }
                if (details.requested.group == "org.jetbrains.kotlin" && details.requested.name == "kotlin-gradle-plugin") {
                    details.useVersion(kotlinVersion)
                }
            }
        }
    }

    afterEvaluate { project ->
        // Firebase Android sources in RNFirebase v23 use Java 16+ language features.
        def isReactNativeFirebase = project.name.startsWith("react-native-firebase_")
        def javaVersionToUse = isReactNativeFirebase ? firebaseJavaVersion : defaultJavaVersion
        def kotlinTargetToUse = isReactNativeFirebase ? firebaseKotlinJvmTarget : defaultKotlinJvmTarget

        if (project.hasProperty("android")) {
            project.android {
                // Some libraries (e.g. Google Sign-In) add BuildConfig fields; AGP can disable this by default.
                // Force-enable BuildConfig generation so those modules configure successfully.
                buildFeatures {
                    buildConfig true
                }
                compileOptions {
                    sourceCompatibility javaVersionToUse
                    targetCompatibility javaVersionToUse
                }
            }
        }
        
        // Force compatible Google Play Services Location version for react-native-geolocation-service
        if (project.name == "react-native-geolocation-service") {
            project.configurations.all {
                resolutionStrategy {
                    force "com.google.android.gms:play-services-location:${rootProject.ext.googlePlayServicesVersion}"
                }
            }
        }

        project.tasks.withType(JavaCompile).configureEach {
            sourceCompatibility = javaVersionToUse
            targetCompatibility = javaVersionToUse
            options.release = (javaVersionToUse == JavaVersion.VERSION_17) ? 17 : 11
        }

        project.tasks.withType(org.jetbrains.kotlin.gradle.tasks.KotlinCompile).configureEach {
            kotlinOptions {
                jvmTarget = kotlinTargetToUse
            }
        }
    }
}
